include("include/SOVIETInstructions.txt");
include("yearlyReport.txt");
include("monthlyCheck.txt");

defineVariable(StatRecord, _thisYearStatRecord);

defineVariable(int, _immigrantsSoviet);
defineVariable(int, _immigrantsAfrica);
defineVariable(int, _immigrantsScore);

defineVariable(int, Day);
defineVariable(int, Month);
defineVariable(int, Year);

defineVariable(char, _isImigrationBlocked);

defineFunction(main, void)
{
	_isImigrationBlocked = 0;
	
	InitConstants();
	
	Date_GetCurrentDate_DMY(Day, Month, Year);
	
	//RunYearlyReport();
	MonthlyCheck(Day, Month, Year);
	
	
	// check start date
	
	//block imigration
	if(! _isImigrationBlocked)
	{
		// get imigration stats
		_thisYearStatRecord.GetFromPresentToDate_DMY(1,1,Year);
		
		_immigrantsSoviet = _thisYearStatRecord.Citizens_ImigrantSoviet;
		_immigrantsAfrica = _thisYearStatRecord.Citizens_ImigrantAfrica;
		_immigrantsScore = _immigrantsSoviet * 3;
		_immigrantsScore = _immigrantsScore + _immigrantsAfrica;
		
		if(_immigrantsScore > 360)
		{
			if(Year > 1960)
			{
				Window_ShowText("Imigration allert");
				Permissions_ImmigrantAllowPurchaseUSD(0, 1.0);
				Permissions_ImmigrantAllowPurchaseRUB(0, 1.0);
				_isImigrationBlocked = 1;
				Window_ShowText("Immigration limit for this year exceeded");
			}
			else()
			{
				if(_immigrantsScore > 1500)
				{
					Window_ShowText("Imigration allert");
					Permissions_ImmigrantAllowPurchaseUSD(0, 1.0);
					Permissions_ImmigrantAllowPurchaseRUB(0, 1.0);
					_isImigrationBlocked = 1;
					Window_ShowText("Immigration limit for this year exceeded");
				}
			}		
		}
	}
	
	// reset imigration at the start of the new year
	if(Month ? 1 & Day ? 1)
	{
		Permissions_ImmigrantAllowPurchaseUSD(1, 1.0);
		Permissions_ImmigrantAllowPurchaseRUB(1, 1.0);
		_isImigrationBlocked = 0;
		Window_ShowText("Immigration limit reset");
	}
	
	// Close borders after sovier union collapse
	if(Year ? 1991 & Month ? 12 & Day = 26)
	{
		Permissions_VehicleAllowPurchaseUSD(0, 0, 0, 0, 0);
		Permissions_VehicleAllowPurchaseRUB(0, 0, 0, 0, 0);
		Permissions_ResourcesAllowPurchaseRUB(0, 0, 1.0);
		Permissions_ResourcesAllowSellRUB(0, 0, 0);
	}
	
	// verify if chains are setup for export
	// verify tourists

	end();
}